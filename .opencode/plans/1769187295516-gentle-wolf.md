# 검색식 생성 서비스 구현 계획 (v2)

## 📋 개요

**목표**: 사용자의 아이디어/특허 문서를 입력받아 KIPRIS에 바로 사용할 수 있는 전문가급 검색식을 AI로 생성하는 서비스

**핵심 전략**: 
- **기본**: AI 원샷 생성 (Option A)
- **고급**: 사용자 주도 반복 개선 (Option C) - KIPRIS API 호출 없이!
- **미래**: Premium 자동 반복 (Option B) - monetize 시

---

## 🎯 서비스 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 1: AI 원샷 생성                                           │
│                                                                 │
│  [사용자 아이디어 입력]                                           │
│          ↓                                                      │
│  AI 검색식 생성 (Gemini)                                         │
│  ├─ 핵심 키워드 추출 (1-3개)                                      │
│  ├─ 유의어 확장 (한/영, 동의어, 상위·하위 개념)                     │
│  ├─ IPC 코드 추천                                                │
│  ├─ NOT 조건 (예상 노이즈 제거)                                   │
│  └─ KIPRIS 문법으로 조합                                         │
│          ↓                                                      │
│  [검색식 출력 + 복사 버튼]                                        │
│          ↓                                                      │
│  💡 "이 검색식으로 KIPRIS에서 테스트해보세요!"                     │
└─────────────────────────────────────────────────────────────────┘
                              ↓ (선택적)
┌─────────────────────────────────────────────────────────────────┐
│  Phase 2: 사용자 주도 반복 개선 (Option C)                        │
│                                                                 │
│  사용자가 KIPRIS 검색 결과를 입력:                                 │
│  ├─ "결과가 너무 많아요 (5000건)"                                 │
│  ├─ "관련없는 의료 분야가 섞여요"                                  │
│  └─ "찾고 싶은 기술이 안 나와요"                                   │
│          ↓                                                      │
│  AI 검색식 개선                                                  │
│  ├─ 결과 많음 → AND 조건 추가, IPC 범위 축소                       │
│  ├─ 노이즈 섞임 → NOT 조건 추가                                   │
│  └─ 누락 → 유의어 추가, 필드 검색 해제                             │
│          ↓                                                      │
│  [개선된 검색식 출력]                                             │
│          ↓                                                      │
│  🔄 반복 가능 (사용자가 원하는 만큼)                               │
└─────────────────────────────────────────────────────────────────┘
```

**핵심 포인트**: 우리 서버에서 KIPRIS API 호출 안 함 → 할당량 문제 없음!

---

## 🏗️ 아키텍처

```
[Frontend]                         [Backend]
    │                                  │
    ▼                                  ▼
/formula 페이지                   /api/v1/formula
├─ 아이디어 입력                  ├─ /generate (원샷 생성)
├─ 검색식 출력 + 복사             └─ /improve (반복 개선)
├─ "KIPRIS에서 테스트" 안내
└─ 피드백 입력 → 개선 요청
```

---

## 📁 수정/생성 파일

### Backend (신규)

| 파일 | 목적 |
|------|------|
| `app/services/formula_generator.py` | 검색식 생성/개선 핵심 로직 |
| `app/schemas/formula.py` | 입출력 스키마 |
| `app/api/formula_routes.py` | API 엔드포인트 |

### Backend (수정)

| 파일 | 변경사항 |
|------|----------|
| `app/main.py` | formula_routes 라우터 등록 |

### Frontend (신규)

| 파일 | 목적 |
|------|------|
| `app/[locale]/formula/page.tsx` | 검색식 생성 페이지 |
| `lib/api.ts` | API 클라이언트 함수 추가 |

---

## 📝 구현 상세

### 1. 데이터 스키마

```python
# 요청
class FormulaGenerateRequest(BaseModel):
    text: str                    # 사용자 아이디어
    options: FormulaOptions | None = None

class FormulaImproveRequest(BaseModel):
    original_formula: str        # 기존 검색식
    feedback: str                # 사용자 피드백 (결과 많음/적음/노이즈 등)
    result_count: int | None     # 검색 결과 수 (선택)

# 응답
class FormulaResult(BaseModel):
    formula: str                 # ((블록체인+"blockchain")*투표*!(결제))
    keywords: list[str]          # [블록체인, 투표]
    synonyms: dict[str, list]    # {블록체인: [blockchain, DLT, 분산원장]}
    ipc_codes: list[str]         # [G06Q, H04L]
    excluded: list[str]          # [결제, 의료]
    explanation: str             # 검색식 해설
    tips: list[str]              # KIPRIS 사용 팁
```

### 2. AI 프롬프트 전략 (전문가 방식 반영)

```
[원샷 생성 프롬프트]

당신은 한국 특허 검색 전문가입니다. 사용자의 아이디어를 분석하여 
KIPRIS 검색식을 생성해주세요.

## 검색식 작성 원칙
1. 기술 요지 파악: 시스템적 분해 (제품 → 유닛 → 모듈 → 특징)
2. 키워드 확장:
   - 동의어/유의어
   - 상위 개념어 / 하위 개념어
   - 영문 번역어, 약어
3. KIPRIS 연산자 활용:
   - AND: * (두 조건 모두)
   - OR: + (하나 이상)
   - NOT: ! (제외)
   - NEAR: ^n (n단어 이내 인접) ← 정확도 높음
   - 구문: "exact phrase"
4. IPC 코드: 메인그룹까지 포함 권장 (예: G06Q20)
5. 노이즈 제거: 예상되는 무관 분야 NOT 조건

## 출력 형식
- formula: KIPRIS 검색식 문자열
- keywords: 핵심 키워드 목록
- synonyms: 각 키워드의 유의어
- ipc_codes: 추천 IPC 코드
- excluded: NOT 조건 키워드
- explanation: 검색식 구조 설명
```

```
[개선 프롬프트]

사용자가 기존 검색식으로 KIPRIS 검색을 했습니다.

기존 검색식: {original_formula}
피드백: {feedback}
검색 결과 수: {result_count}건

## 개선 방향
- 결과 많음 → AND 조건 추가, ^n 인접연산자 사용, IPC 범위 축소
- 결과 적음 → OR로 유의어 추가, IPC 범위 확장
- 노이즈 → NOT 조건 추가
- 누락 → 상위/하위 개념어 추가
```

### 3. KIPRIS 검색식 문법 참조

| 연산자 | 기호 | 예시 | 설명 |
|--------|------|------|------|
| AND | `*` | `자동차*브레이크` | 둘 다 포함 |
| OR | `+` | `자동차+차량` | 하나 이상 |
| NOT | `!` | `자동차!클러치` | 제외 |
| NEAR | `^n` | `레이저^2광원` | n단어 이내 인접 (정확도↑) |
| 구문 | `""` | `"데이터 신호"` | 정확한 문구 |
| 필드 | `TI:`, `AB:` 등 | `TI:(휴대폰*배터리)` | 특정 필드만 |
| 절단 | `?` | `디스플레?` | 한 글자 대체 |

---

## 🌿 브랜치 전략

**새 브랜치**: `feature/formula-generation` (main 기반)

**이유**: SNA 필터링(PR #2)과 완전히 독립적

---

## ✅ 구현 체크리스트

### Phase 1: Backend - 원샷 생성
- [ ] `FormulaResult`, `FormulaGenerateRequest` 스키마 정의
- [ ] `formula_generator.py` - `generate_formula()` 구현
- [ ] Gemini AI 프롬프트 작성 (전문가 방식 반영)
- [ ] `POST /api/v1/formula/generate` 엔드포인트
- [ ] 단위 테스트

### Phase 2: Backend - 반복 개선
- [ ] `FormulaImproveRequest` 스키마 정의
- [ ] `formula_generator.py` - `improve_formula()` 구현
- [ ] 개선용 프롬프트 작성
- [ ] `POST /api/v1/formula/improve` 엔드포인트

### Phase 3: Frontend
- [ ] `/formula` 페이지 생성
- [ ] 아이디어 입력 UI (textarea)
- [ ] 검색식 출력 + 복사 버튼
- [ ] "KIPRIS에서 테스트해보세요" 안내 + 링크
- [ ] 피드백 입력 UI (결과 많음/적음/노이즈 선택)
- [ ] 개선 요청 → 개선된 검색식 표시
- [ ] 히스토리 (이전 버전과 비교)

---

## 🧪 검증 방법

1. **단위 테스트**: `pytest tests/test_formula_generator.py`
2. **AI 출력 검증**: 생성된 검색식이 KIPRIS 문법에 맞는지 검증
3. **수동 테스트**:
   - 생성된 검색식을 KIPRIS 웹사이트에 붙여넣기
   - 검색 결과 수와 관련도 확인
   - 피드백 입력 후 개선된 검색식 재테스트

---

## ⚠️ 고려사항

1. **Gemini API 토큰**: 긴 아이디어 입력 시 토큰 제한 고려
2. **검색식 복잡도**: 너무 복잡하면 KIPRIS에서 오류 가능
3. **유의어 정확도**: 잘못된 유의어로 노이즈 증가 가능
4. **IPC 정확성**: AI 추천 IPC가 틀릴 수 있음 → 사용자 검증 권장

---

## 🚀 향후 확장 (Premium/Monetize)

```
[Option B: 자동 반복 - Premium Plan]
├─ 우리 서버에서 KIPRIS API 호출
├─ 검색 결과 자동 분석 → IPC 빈도 추출
├─ 자동으로 개선된 검색식 제안
└─ 유료 API 키 필요
```
